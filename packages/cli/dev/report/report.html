<!DOCTYPE html>
<html>

<head>
  <title>Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #fbfcfe;
    }

    figure {
      margin: 0;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #e1e1e2;
      border-radius: 8px;
    }

    figure h2 {
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 4px;
    }
  </style>
</head>

<body>
  <div class="p-8 bg-white shadow">
    <h1 class="text-4xl mb-1">Backtest Report</h1>
    <p class="text-sm"><b>Date generated</b>: <span id="date"></span></p>
    <p class="text-sm"><b>File</b>: <span id="file"></span></p>
    <p class="text-sm"><b>Start Cash</b>: <span id="cash1"></span></p>
    <p class="text-sm"><b>End Cash</b>: <span id="cash2"></span></p>
  </div>
  <hr />
  <div id="container" class="grid grid-cols-2 p-4 gap-4"></div>

  <script type="importmap">
    {
      "imports": {
        "@observablehq/plot": "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm",
        "@zapcli/reports": "./../../../reports/dist/zapcli-reports.es.js"
      }
    }
  </script>
  <script type="module">

    import * as Plot from "@observablehq/plot"
    import renderReport from "@zapcli/reports"

    const formatNumber = (val) => {
      if (val >= 1000) {
        const formattedValue = (val / 1000).toFixed(1);
        return `$${formattedValue}k`;
      } else {

        const op = {
          style: 'currency',
          currency: 'USD',
          maximumFractionDigits: 3
        }

        return val.toLocaleString('en-US', op)
      }
    }

    const container = document.querySelector("#container")

    fetch('./data.json')
      .then(response => response.json())
      .then(data => {
        run(data)
      })
      .catch(error => console.error(error))

    function run(data) {

      const plots = Object.keys(data.analyzers).map(name => renderReport(name, data.analyzers[name])).flat()
      plots.forEach(plot => {
        plot.classList.add(..."shadow bg-white".split(" "))
        container.append(plot)
      })

      // const ddData = data.analyzers['drawdown']
      // const plotDDData = ddData['drawDowns'].map((d) => {
      //   return {
      //     ...d,
      //     date: new Date(d.date),
      //     dateFormattted: d.date
      //   }
      // })

      // const plot1 = Plot.plot({
      //   inset: 0,
      //   marginLeft: 60,
      //   height: 300,
      //   title: "Cash & Value",
      //   x: { grid: false, label: "Date" },
      //   y: { grid: true, tickFormat: val => formatNumber(val), insetTop: 15, label: "Cash & Value" },
      //   marks: [
      //     Plot.frame(),
      //     // Plot.dot(plotData, { x: "date", y: "value", fill: 'gray', stroke: 'black', tip: true, filter: d => d.date.getDate() === 1 }),
      //     Plot.lineY(plotData, { x: "date", y: "value" }),
      //     // Plot.lineY(plotDDData, { x: "date", y: "max", stroke: 'red' }),
      //     Plot.areaY(plotDDData, {
      //       x: "date",
      //       y1: (d) => d.max,
      //       y2: (d) => d.max - d.moneyDown,
      //       fill: "red", // Color of the area
      //       opacity: 0.2, // Transparency of the area,
      //       filter: d => new Date(d.date).getTime() >= new Date(ddData.maxDrawDownStart).getTime()
      //         && new Date(d.date).getTime() <= new Date(ddData.maxDrawDownEnd).getTime()
      //     }),
      //     Plot.dot(plotDDData, { x: "date", y: "max", fill: 'gray', stroke: 'red', tip: true, filter: d => d.dateFormattted === ddData.maxDrawDownStart || d.date === ddData.maxDrawDownEnd }),
      //     Plot.lineY(plotDDData, { x: "date", y: "max", stroke: 'red', filter: d => new Date(d.date).getTime() >= new Date(ddData.maxDrawDownStart).getTime() && new Date(d.date).getTime() < new Date(ddData.maxDrawDownEnd).getTime() })
      //   ]
      // })

      // container.append(plot1)

      document.getElementById('file').textContent = data.file;
      document.getElementById('cash1').textContent = data.startCash;
      document.getElementById('cash2').textContent = data.endCash;
      document.getElementById('date').textContent = data.dateGenerated
    }


  </script>
</body>

</html>